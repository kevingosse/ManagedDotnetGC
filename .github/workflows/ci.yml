name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
          - os: ubuntu-latest
            runtime: linux-x64
          - os: ubuntu-latest
            runtime: linux-arm64
      fail-fast: false
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'preview'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build and publish ManagedDotnetGC in Release mode
      run: dotnet publish ./ManagedDotnetGC /p:SelfContained=true -r ${{ matrix.runtime }} -c Release
    
    - name: Build TestApp in Release mode
      run: dotnet build ./TestApp -r ${{ matrix.runtime }} -c Release
    
    - name: Copy GC DLL to TestApp directory
      shell: bash
      run: |
        cp ./ManagedDotnetGC/bin/Release/net10.0/${{ matrix.runtime }}/publish/* ./TestApp/bin/Release/net10.0/${{ matrix.runtime }}/
    
    - name: Run unit tests
      run: dotnet test ./ManagedDotnetGC.Tests -c Release --verbosity normal
    
    - name: Run TestApp with custom GC (Windows)
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: |
        set DOTNET_GCName=ManagedDotnetGC.dll
        set DOTNET_gcConservative=0
        .\TestApp\bin\Release\net10.0\${{ matrix.runtime }}\TestApp.exe
    
    - name: Run TestApp with custom GC (Linux)
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        export DOTNET_GCName=ManagedDotnetGC.dll
        export DOTNET_gcConservative=0
        chmod +x ./TestApp/bin/Release/net10.0/${{ matrix.runtime }}/TestApp
        ./TestApp/bin/Release/net10.0/${{ matrix.runtime }}/TestApp
