name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: windows-latest
    
    env:
      DOTNET_TARGET_FRAMEWORK: net10.0
      RUNTIME: win-x64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'preview'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build and publish ManagedDotnetGC in Release mode
      run: dotnet publish ./ManagedDotnetGC /p:SelfContained=true -r ${{ env.RUNTIME }} -c Release
    
    - name: Build TestApp in Release mode
      run: dotnet build ./TestApp -r ${{ env.RUNTIME }} -c Release
    
    - name: Copy GC DLL to TestApp directory
      shell: bash
      run: |
        cp ./ManagedDotnetGC/bin/Release/${{ env.DOTNET_TARGET_FRAMEWORK }}/${{ env.RUNTIME }}/publish/* ./TestApp/bin/Release/${{ env.DOTNET_TARGET_FRAMEWORK }}/${{ env.RUNTIME }}/
    
    - name: Run unit tests
      run: dotnet test ./ManagedDotnetGC.Tests -c Release --verbosity normal
    
    - name: Run TestApp with custom GC
      shell: cmd
      run: |
        set DOTNET_GCName=ManagedDotnetGC.dll
        set DOTNET_gcConservative=0
        .\TestApp\bin\Release\${{ env.DOTNET_TARGET_FRAMEWORK }}\${{ env.RUNTIME }}\TestApp.exe
